---
- name: Reset Grafana and Prometheus containers and volumes
  hosts: local_nodes
  become: yes
  tasks:
    - name: Stop and remove Prometheus container
      shell: |
        docker stop prometheus || true
        docker rm prometheus || true
      ignore_errors: yes

    - name: Stop and remove Grafana container
      shell: |
        docker stop grafana || true
        docker rm grafana || true
      ignore_errors: yes

    - name: Stop and remove Node-exporter container
      shell: |
        docker stop node-exporter || true
        docker rm node-exporter || true
      ignore_errors: yes

    - name: Remove Prometheus volumes and networks
      shell: |
        docker volume rm prometheus_prometheus_data || true
        docker network rm prometheus_default || true
      ignore_errors: yes

    - name: Remove Grafana volumes and networks
      shell: |
        docker volume rm grafana_grafana_data || true
        docker network rm grafana_default || true
      ignore_errors: yes

    - name: Clean up any orphaned containers and volumes
      shell: |
        docker system prune -f
        docker volume prune -f
      ignore_errors: yes

    - name: Show remaining containers and volumes
      shell: |
        echo "=== Remaining containers ==="
        docker ps -a
        echo "=== Remaining volumes ==="
        docker volume ls
      register: docker_status

    - name: Display Docker status
      debug:
        var: docker_status.stdout_lines