---
- name: Reset API, Grafana API, and monitoring containers and volumes
  hosts: local_nodes
  become: yes
  tasks:
    - name: Stop and remove Simple Time API container
      shell: |
        docker stop simple-time-api || true
        docker rm simple-time-api || true
      ignore_errors: yes

    - name: Stop and remove Grafana API container
      shell: |
        docker stop grafana-api || true
        docker rm grafana-api || true
      ignore_errors: yes

    - name: Stop and remove legacy Prometheus container
      shell: |
        docker stop prometheus || true
        docker rm prometheus || true
      ignore_errors: yes

    - name: Stop and remove legacy Grafana container
      shell: |
        docker stop grafana || true
        docker rm grafana || true
      ignore_errors: yes

    - name: Stop and remove Node-exporter container
      shell: |
        docker stop node-exporter || true
        docker rm node-exporter || true
      ignore_errors: yes

    - name: Remove API and Grafana API volumes and networks
      shell: |
        docker volume rm simple-time-api_default || true
        docker volume rm grafana-api_grafana_data || true
        docker network rm simple-time-api_default || true
        docker network rm grafana-api_default || true
      ignore_errors: yes

    - name: Remove legacy Prometheus volumes and networks
      shell: |
        docker volume rm prometheus_prometheus_data || true
        docker network rm prometheus_default || true
      ignore_errors: yes

    - name: Remove legacy Grafana volumes and networks
      shell: |
        docker volume rm grafana_grafana_data || true
        docker network rm grafana_default || true
      ignore_errors: yes

    - name: Remove deployment directories
      shell: |
        rm -rf ~/simple-time-api || true
        rm -rf ~/grafana-api || true
        rm -rf /opt/grafana || true
        rm -rf /opt/prometheus || true
      ignore_errors: yes

    - name: Clean up any orphaned containers and volumes
      shell: |
        docker system prune -f
        docker volume prune -f
      ignore_errors: yes

    - name: Display Docker status
      debug:
        msg:
          - "ðŸ§¹ Cleanup complete!"
          - "âœ… Removed Simple Time API containers and volumes"
          - "âœ… Removed Grafana API containers and volumes" 
          - "âœ… Removed legacy monitoring containers"
          - "âœ… Cleaned up deployment directories"
          - ""
          - "ðŸ“Š Current Docker status:"
        
    - name: Show remaining containers and volumes
      shell: |
        echo "=== Remaining containers ==="
        docker ps -a
        echo "=== Remaining volumes ==="
        docker volume ls
      register: docker_status

    - name: Display remaining Docker resources
      debug:
        var: docker_status.stdout_linesd