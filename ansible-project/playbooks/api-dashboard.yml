---
- name: Deploy Time Metrics API with Grafana Dashboard
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    api_port: 8000
    grafana_port: 3000
  
  tasks:
    - name: Check Docker installation
      shell: docker --version
      register: docker_check
      ignore_errors: yes

    - name: Display Docker status
      debug:
        msg: "Docker version: {{ docker_check.stdout | default('Not installed') }}"

    - name: Deploy Simple Metrics API
      include_role:
        name: simple_metrics_api
      vars:
        port: "{{ api_port }}"

    - name: Deploy Grafana with API Dashboard
      include_role:
        name: grafana_api

    - name: Wait for both services to be ready
      uri:
        url: "{{ item.url }}"
        method: GET
        timeout: 10
      register: service_health
      until: service_health.status == 200
      retries: 30
      delay: 5
      with_items:
        - { url: "http://localhost:{{ api_port }}/health", service: "Metrics API" }
        - { url: "http://localhost:{{ grafana_port }}/api/health", service: "Grafana" }

    - name: Display deployment summary
      debug:
        msg:
          - "ðŸš€ Complete deployment successful!"
          - ""
          - "ðŸ“Š Metrics API: http://localhost:{{ api_port }}"
          - "   â””â”€â”€ Authenticated Endpoint: http://localhost:{{ api_port }}/metrics"
          - "   â””â”€â”€ Health Check: http://localhost:{{ api_port }}/health"
          - "   â””â”€â”€ Bearer Token: grafana-token"
          - ""
          - "ðŸ“ˆ Grafana Dashboard: http://localhost:{{ grafana_port }}"
          - "   â””â”€â”€ Login: admin / admin"
          - "   â””â”€â”€ Dashboard: Time Metrics Dashboard"
          - ""
          - "âœ… API with Bearer token authentication"
          - "âœ… Dashboard auto-provisioned and ready to use"