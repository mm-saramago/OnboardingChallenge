---
- name: Install cron package
  apt:
    name: cron
    state: present
    update_cache: yes

- name: Check if cron service exists
  shell: systemctl list-unit-files | grep -E "(cron|cronie)"
  register: cron_service_check
  changed_when: false
  failed_when: false

- name: Start and enable cron service (if it exists)
  shell: |
    if command -v systemctl >/dev/null 2>&1; then
      systemctl start cron || systemctl start crond || true
      systemctl enable cron || systemctl enable crond || true
    else
      # For containers without systemd, start cron manually
      service cron start || /etc/init.d/cron start || cron || true
    fi
  failed_when: false

- name: Verify cron daemon is running
  shell: pgrep -f cron || ps aux | grep -v grep | grep cron
  register: cron_running
  changed_when: false
  failed_when: false

- name: Display cron status
  debug:
    msg: "Cron daemon status: {{ 'Running' if cron_running.rc == 0 else 'Not running' }}"

- name: Verify crontab is available
  shell: which crontab
  register: crontab_check
  changed_when: false

- name: Copy scripts to target host
  copy:
    src: "{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: '0755'
    owner: root
    group: root
  loop:
    - system-metrics.sh
    - subminute_runner.sh

- name: Create log directory
  file:
    path: /var/log
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create metrics directory for textfile collector (matching docker-compose mount)
  file:
    path: /tmp/metrics
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Add cronjob for system metrics collection (every 10 seconds)
  cron:
    name: "System metrics collection"
    job: "/bin/bash /usr/local/bin/subminute_runner.sh"
    user: root
    state: present
    cron_file: ansible_metrics

- name: Verify cronjob was added
  shell: cat /etc/cron.d/ansible_metrics | grep "subminute_runner"
  register: cron_check
  changed_when: false
  failed_when: false

- name: Display cronjob status
  debug:
    msg: "Cronjob status: {{ 'Found' if cron_check.rc == 0 else 'Not found' }}"