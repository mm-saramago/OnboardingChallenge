---
- name: Copy scripts to target host
  copy:
    src: "{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: '0755'
    owner: root
    group: root
  loop:
    - system-metrics.sh
    - subminute_runner.sh

- name: Create log directory
  file:
    path: /var/log
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create metrics directory for textfile collector (matching docker-compose mount)
  file:
    path: /tmp/metrics
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Add cronjob for system metrics collection (every 10 seconds)
  cron:
    name: "System metrics collection"
    job: "/bin/bash /usr/local/bin/subminute_runner.sh"
    user: root
    state: present
    cron_file: ansible_metrics

- name: Verify cronjob was added
  shell: cat /etc/cron.d/ansible_metrics | grep "subminute_runner"
  register: cron_check
  changed_when: false
  failed_when: false

- name: Display cronjob status
  debug:
    msg: "Cronjob status: {{ 'Found' if cron_check.rc == 0 else 'Not found' }}"